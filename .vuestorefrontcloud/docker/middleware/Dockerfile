FROM node:16-alpine

ARG NPM_EMAIL
ARG NPM_PASS
ARG NPM_USER
ARG NPM_REGISTRY
ARG EPCC_CLIENT_ID
ARG EPCC_CLIENT_SECRET
ARG EPCC_MULTISTORE_ONE_HOST
ARG EPCC_MULTISTORE_ONE_CLIENT_ID
ARG EPCC_MULTISTORE_ONE_CLIENT_SECRET
ARG EPCC_MULTISTORE_TWO_HOST
ARG EPCC_MULTISTORE_TWO_CLIENT_ID
ARG EPCC_MULTISTORE_TWO_CLIENT_SECRET
ARG EPCC_BASE_HOST
ARG EPCC_BASE_CDN_HOST

ENV EPCC_CLIENT_ID=${EPCC_CLIENT_ID}
ENV EPCC_CLIENT_SECRET=${EPCC_CLIENT_SECRET}
ENV EPCC_MULTISTORE_ONE_HOST=${EPCC_MULTISTORE_ONE_HOST}
ENV EPCC_MULTISTORE_ONE_CLIENT_ID=${EPCC_MULTISTORE_ONE_CLIENT_ID}
ENV EPCC_MULTISTORE_ONE_CLIENT_SECRET=${EPCC_MULTISTORE_ONE_CLIENT_SECRET}
ENV EPCC_MULTISTORE_TWO_HOST=${EPCC_MULTISTORE_TWO_HOST}
ENV EPCC_MULTISTORE_TWO_CLIENT_ID=${EPCC_MULTISTORE_TWO_CLIENT_ID}
ENV EPCC_MULTISTORE_TWO_CLIENT_SECRET=${EPCC_MULTISTORE_TWO_CLIENT_SECRET}
ENV EPCC_BASE_HOST=${EPCC_BASE_HOST}
ENV EPCC_BASE_CDN_HOST=${EPCC_BASE_CDN_HOST}

WORKDIR /var/www

COPY middleware.js middleware.config.js multistore.config.js .npmrc .vuestorefrontcloud/docker/middleware/package.json ./

RUN npm install -g npm-cli-login && npm-cli-login \
    && yarn install --network-concurrency 1 \
    && yarn cache clean --all

EXPOSE 8181

ENTRYPOINT ["yarn", "start:middleware"]
